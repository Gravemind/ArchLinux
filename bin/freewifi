#!/bin/bash

INTERFACE='wlan0'


#IW_ADDR='7A:A4:42:A7:92:36'
#IW_ADDR='36:C8:44:F5:05:AA'
#IW_ADDR='2E:1B:33:E6:16:22'
#IW_ADDR='E6:A6:53:55:50:02'
#IW_ADDR='CE:A0:D3:DC:7C:3E'
#IW_ADDR='A2:EA:65:61:30:9A'
#IW_ADDR='00:24:D4:56:8C:4D'
IW_ADDR='F2:4B:47:36:E5:D6'
#IW_ADDR='F4:CA:E5:CA:78:55'
IW_SSID='FreeWifi'

sudo echo 'Start'

RES=`sudo iwconfig $INTERFACE | grep "Access Point" | grep "Not-Associated"`
if [[ -n "$RES" || -n "$1" ]]
then

    sudo /etc/rc.d/net-auto-wireless stop

    sleep 1

    sudo ifconfig $INTERFACE down

    sleep 1

    sudo iwconfig $INTERFACE mode Managed ap $IW_ADDR key open

    sleep 1

    sudo iwconfig $INTERFACE essid "$IW_SSID" 

    sleep 1

    sudo ifconfig $INTERFACE up

    sleep 2

    sudo iwconfig $INTERFACE

    sleep 2

fi

RES=`sudo iwconfig $INTERFACE | grep "Access Point" | grep "Not-Associated"`
if [[ -n "$RES" || -n "$1" ]]
then
    echo 'FAIL assoc'
    exit 1
fi

RES=`ifconfig $INTERFACE  | grep 'inet '`
if [[ -z "$RES" || -n "$2" ]]
then
    sudo dhcpcd -x $INTERFACE -t 30
    sudo dhcpcd $INTERFACE
    sleep 2
fi

FREEWIFI_LOGIN=""
FREEWIFI_PASS=""

wget -O - --post-data="login=$FREEWIFI_LOGIN&password=$FREEWIFI_PASS" "https://wifi.free.fr/Auth" 2> /dev/null | grep "CONNEXION AU SERVICE REUSSIE"

echo "\a"
echo 'end'
