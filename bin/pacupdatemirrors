#!/bin/sh

set -eo pipefail

# Original source: https://gist.github.com/ByScripts/3496113

[ "$UID" != 0 ] && su=sudo

countries='country=FI&country=FR&country=DE&country=LU&country=NL&country=PL&country=SE'
#safemove="mv -i"
safemove="mv"

url="https://www.archlinux.org/mirrorlist/?${countries}&protocol=https&ip_version=4&ip_version=6&use_mirror_status=on"
servercount=4
tmpfile=$(mktemp --suffix=-mirrorlist)
tmpfile2=$(mktemp --suffix=-mirrorlist2)

echo "$0: fetching ${url}"

wget -qO- "$url" | sed 's/^#Server/Server/g' > "$tmpfile"

# strip comments and empty lines, keep only last (better ranking) $servercount servers
(grep -v -e '^#' -e '^$' "$tmpfile" || true) | tail -n $servercount > "$tmpfile2"

count="$(\cat "$tmpfile2" | wc -l || true)"
if [[ -z "$count" || "$count" -le "0" ]]
then
	echo "$0: error: could not find new mirrors, here is what I got:"
	cat "$tmpfile"
	exit 1
fi

echo "$0: ranking the new $count mirrors..."

rm -f "$tmpfile"
rankmirrors -n 0 -v "$tmpfile2" > "$tmpfile"

if [[ ! -s "$tmpfile" ]]
then
	echo "$0: error: ranking mirrors failed, reading list:"
	cat "$tmpfile2"
	exit 1
fi

echo "$0: backing up and Saving new mirrorlist..."

$su $safemove /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.orig
$su $safemove "$tmpfile" /etc/pacman.d/mirrorlist
$su chmod 644 /etc/pacman.d/mirrorlist

if [[ -f /etc/pacman.d/mirrorlist.pacnew ]]
then
	echo "$0: removing /etc/pacman.d/mirrorlist.pacnew"
	$su rm /etc/pacman.d/mirrorlist.pacnew
fi

echo "$0: here is the new mirrorlist:";
cat /etc/pacman.d/mirrorlist
rm -f "$tmpfile" "$tmpfile2"

echo "$0: OK, now refreshing packages with pacman";
if command -v pacaur >/dev/null 2>&1
then
	pacaur -Syy
else
	pacman -Syy
fi
