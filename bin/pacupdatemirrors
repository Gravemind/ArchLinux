#!/bin/sh

set -eo pipefail

countries=(-c fi -c fr -c de -c lu -c nl -c pl -c se)
servercount=5
safemove="mv"
tmpfile=$(mktemp --suffix=-mirrorlist)
tmpfile2=$(mktemp --suffix=-mirrorlist2)

echo "$0: fetch mirrors..."

reflector --verbose -p https "${countries[@]}" --sort score --age 24 \
    | grep '^Server = ' | tail -n $servercount > "$tmpfile2"

echo "$0: ranking the new $count mirrors..."

rm -f "$tmpfile"
rankmirrors -n 0 -v "$tmpfile2" > "$tmpfile"

if [[ ! -s "$tmpfile" ]]
then
	echo "$0: error: ranking mirrors failed, reading list:"
	cat "$tmpfile2"
	exit 1
fi

echo "$0: backing up and Saving new mirrorlist..."

[ "$UID" != 0 ] && su=sudo

$su $safemove /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.orig
$su $safemove "$tmpfile" /etc/pacman.d/mirrorlist
$su chmod 644 /etc/pacman.d/mirrorlist

if [[ -f /etc/pacman.d/mirrorlist.pacnew ]]
then
	echo "$0: removing /etc/pacman.d/mirrorlist.pacnew"
	$su rm /etc/pacman.d/mirrorlist.pacnew
fi

echo "$0: here is the new mirrorlist:";
cat /etc/pacman.d/mirrorlist
rm -f "$tmpfile" "$tmpfile2"

echo "$0: OK, now refreshing packages with pacman";
if command -v pacaur >/dev/null 2>&1
then
	pacaur -Syy
else
	pacman -Syy
fi
